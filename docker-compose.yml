# =======================================================
# DOCKER COMPOSE PARA PORTAINER STACK
# API ADB WhatsApp v3.0 - Produção
# =======================================================
version: '3.8'

services:
  # =======================================================
  # Redis - Fila FIFO com persistência
  # =======================================================
  redis:
    image: redis:7-alpine
    container_name: whatsapp-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server 
      --appendonly yes 
      --maxmemory 1gb 
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    restart: unless-stopped
    networks:
      - whatsapp-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # =======================================================
  # Redis Commander - Interface visual (opcional)
  # Acesso: http://SEU_IP:8081
  # =======================================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: whatsapp-redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379
    ports:
      - "8081:8081"
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - whatsapp-network

  # =======================================================
  # Dispatcher - API Principal (IMAGEM DO DOCKER HUB)
  # =======================================================
  dispatcher:
    image: jondevsouza31/api-adb:v3.0.0
    container_name: whatsapp-dispatcher
    ports:
      - "8080:8080"
    environment:
      # Node.js
      - NODE_ENV=production
      - PORT=8080
      
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      
      # Supabase (DEFINA NO PORTAINER)
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      
      # N8N Webhook (DEFINA NO PORTAINER)
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}
      
      # Configurações de coordenadas adaptativas
      - BASE_WIDTH=720
      - BASE_HEIGHT=1600
      
      # Intervalos (em milissegundos)
      - POLLING_INTERVAL=1500
      - HEALTH_CHECK_INTERVAL=30000
      - NOTIFICATION_INTERVAL=3000
      
    depends_on:
      - redis
    restart: unless-stopped
    privileged: true  # Necessário para ADB
    network_mode: host  # Necessário para ADB WiFi descobrir devices na rede local
    
    # ATENÇÃO: network_mode: host sobrescreve 'ports' e 'networks'
    # Se seu ambiente não suportar host mode, comente a linha acima e descomente:
    # networks:
    #   - whatsapp-network

  # =======================================================
  # Dashboard Web - Interface de Gerenciamento Vue.js
  # Acesso: http://SEU_IP:3000
  # =======================================================
  dashboard:
    image: jondevsouza31/api-adb-dashboard:v3.0.0
    container_name: whatsapp-dashboard
    ports:
      - "3000:80"
    environment:
      - VITE_API_URL=http://localhost:8080
    depends_on:
      - dispatcher
    restart: unless-stopped
    networks:
      - whatsapp-network

# =======================================================
# Networks
# =======================================================
networks:
  whatsapp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# =======================================================
# Volumes persistentes
# =======================================================
volumes:
  redis_data:
    driver: local
